function getOptions(a){chrome.extension.sendRequest({action:"getOptions"},function(b){b.ColorOptions&&(Options=b.ColorOptions),a&&a()})}function getOptVal(a){return null!==Options?Options[a][1]:void 0}function OnCheckCloseWindow(){if(!inDictPannel){if(null!=last_frame){var a=(new Date).getTime();if(500>a-last_time)return;for(;0!=list.length;)body.removeChild(list.pop());return last_frame=null,last_div=null,!0}return!1}}function OnCheckCloseWindowForce(){if(inDictPannel=!1,null!=last_frame){for((new Date).getTime();0!=list.length;)body.removeChild(list.pop());return last_frame=null,last_div=null,!0}return!1}function createPopUpEx(a,b,c,d,e){OnCheckCloseWindowForce(),createPopUp(a,window.getSelection().getRangeAt(0).startContainer.nodeValue,b,c,d,e)}function createPopUp(a,b,c,d,e,f){var g=150,h=300,i=10,j=0,k=0,l=document.createElement("div");l.id="yddWrapper",l.setAttribute("draggable",!0);var m=screen.availWidth,n=screen.availHeight;j=m>e+h?c:c-h-2*i,l.style.left=j+"px",k=n>f+g+20?d:d-g-2*i,l.style.top=k+10+"px",l.style.position="absolute",l.style.left+h>m&&(l.style.left-=l.style.left+h-m),l.innerHTML+=a,l.onmouseover=function(a){inDictPannel=!0},l.onmouseout=function(a){inDictPannel=!1},body.style.position="static",body.appendChild(l),list.push(l);var o,p;l.ondragstart=function(a){o=a.x-parseInt(l.style.left),p=a.y-parseInt(l.style.top)},l.ondragend=function(a){l.style.left=a.x-o+"px",l.style.top=a.y-p+"px",o=0,p=0},document.querySelector("#yddMiddle").setAttribute("draggable",!0),document.querySelector("#yddMiddle").ondragstart=function(a){a.preventDefault()};var q=document.querySelector(".ydd-close");q.onclick=function(a){OnCheckCloseWindowForce()},q=null;var r=document.getElementById("ydd-voice");if(r)if("http:"==window.location.protocol){if(""!=r.innerHTML){r.innerHTML=insertAudio("http://dict.youdao.com/speech?audio="+r.innerHTML);var s=document.getElementById("speach_flash");if(null!=s)try{s.StopPlay()}catch(t){}}}else r.innerHTML="";var u=k+10+document.getElementById("yddWrapper").clientHeight;if(d>u){var v=d-document.getElementById("yddWrapper").clientHeight;l.style.top=v+"px"}return null!=last_frame&&last_frame.style.top==l.style.top&&last_frame.style.left==l.style.left?(body.removeChild(l),void list.pop()):(last_time=(new Date).getTime(),void(last_frame=l))}function insertAudio(a){return['<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0" width="15px" height="15px" align="absmiddle" id="speach_flash">','<param name="allowScriptAccess" value="sameDomain" />','<param name="movie" value="http://cidian.youdao.com/chromeplus/voice.swf" />','<param name="loop" value="false" />','<param name="menu" value="false" />','<param name="quality" value="high" />','<param name="wmode"  value="transparent">','<param name="FlashVars" value="audio=',a,'">','<embed wmode="transparent" src="http://cidian.youdao.com/chromeplus/voice.swf" loop="false" menu="false" quality="high" bgcolor="#ffffff" width="15" height="15" align="absmiddle" allowScriptAccess="sameDomain" FlashVars="audio=',a,'" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />',"</object>"].join("")}function getYoudaoDict(a,b,c,d,e,f){chrome.extension.sendRequest({action:"dict",word:a,x:b,y:c,screenX:d,screenY:e},function(a){f&&f(a)})}function getYoudaoTrans(a,b,c,d,e,f){chrome.extension.sendRequest({action:"translate",word:a,x:b,y:c,screenX:d,screenY:e},function(a){f&&f(a)})}var body=document.querySelector("body"),Options,last_frame,last_div,list=[],last_time=0,last_request_time=0,TriggerDelay=350,youdaoStyle=document.createElement("style"),styleContent=document.createTextNode("#yddContainer{display:block;font-family:Microsoft YaHei;position:relative;width:100%;height:100%;font-size:12px;border:1px solid #4b7598;background:#fff;}#yddTop{display:block;height:22px;cursor:move;border-bottom: 1px solid #d7e3eb; background: #e1f1fb;}#yddTopBorderlr{display:block;position:static;height:22px;line-height:22px;padding:0 28px;font-size:12px;color:#5079bb;font-weight:bold;}#yddWrapper .ydd-icon{display: inline-block; position: absolute; left: 5px; top: 2px; width: 17px; height: 17px;background:url("+chrome.extension.getURL("icon-yd-dict.png")+") no-repeat;}.ydd-close{display: inline-block; width: 20px; height: 22px; line-height: 22px; font-size: 16px; position: absolute; right: 0; padding-left: 4px; text-decoration: none!important; cursor: pointer;}#yddKeyTitle{float:left;text-decoration:none}#yddMiddle{display:block;margin-bottom:10px}.ydd-tabs{display:block;margin:5px 0;padding:0 5px;height:18px;border-bottom:1px solid}.ydd-tab{display:block;float:left;height:18px;margin:0 5px -1px 0;padding:0 4px;line-height:18px;border:1px solid;border-bottom:none}.ydd-trans-container{display:block;line-height:160%}.ydd-trans-container a{text-decoration:none;}#yddBottom{position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;overflow:hidden;background-position:left -22px}.ydd-padding010{padding:0 10px}#yddWrapper{-webkit-user-drag:element;color:#252525;z-index:10001;box-shadow: 2px 2px 4px gray;}#yddWrapper a,#yddWrapper a:hover,#yddWrapper a:visited{color:#50799b}#yddWrapper .ydd-tabs{color:#959595}.ydd-tabs,.ydd-tab{background:#fff;border-color:#d5e7f3}#yddBottom{color:#363636}#yddWrapper{min-width:250px;max-width:400px;}#ydd-voice{margin-left:2px;height:15px;width:15px}#ydd-voice object{vertical-align: top;}");youdaoStyle.type="text/css",youdaoStyle.setAttribute("info","这是有道词典划词扩展插入的样式"),youdaoStyle.styleSheet?youdaoStyle.styleSheet.cssText=styleContent.nodeValue:(youdaoStyle.appendChild(styleContent),document.querySelector("head").appendChild(youdaoStyle)),getOptions(),body.addEventListener("mouseup",function(a){clearTimeout(window._ydTimerSelect),window._ydTimerSelect=setTimeout(function(){var b=window.getSelection().toString();if(""!==b&&(b=b.trim()),b.length<1||b.length>2e3)return void OnCheckCloseWindow();if(!inDictPannel&&(OnCheckCloseWindow(),getOptVal("dict_enable"))){if(getOptVal("english_only")){if(isContainJapanese(b)||isContainKoera(b)||isContainChinese(b))return;b=ExtractEnglish(b)}else if(!isContainChinese(b)&&spaceCount(b)>=3||isContainChinese(b)&&b.length>4||isContainJapanese(b)&&b.length>4){var c=a.pageX,d=a.pageY,e=a.screenX,f=a.screenY;return void getYoudaoTrans(b,a.pageX,a.pageY,a.screenX,a.screenY,function(a){createPopUpEx(a,c,d,e,f)})}if(""!=b){OnCheckCloseWindowForce();var c=a.pageX,d=a.pageY,e=a.screenX,f=a.screenY;return void getYoudaoDict(b,a.pageX,a.pageY,a.screenX,a.screenY,function(a){createPopUpEx(a,c,d,e,f)})}}},TriggerDelay)},!1);var prevC,prevO,prevWord,c;document.addEventListener("mousemove",function(a){clearTimeout(window._ydTimer),a.ctrlKey&&(window._ydTimer=setTimeout(function(){if(getOptVal("ctrl_only")){var b=document.caretRangeFromPoint(a.clientX,a.clientY);if(!b)return!0;pX=a.pageX,pY=a.pageY;var c=b.startOffset,d=b.endOffset;if(prevC===b.startContainer&&prevO===c)return!0;prevC=b.startContainer,prevO=c;var e=b.cloneRange(),f="";if(b.startContainer.data)for(;c>=1;)if(e.setStart(b.startContainer,--c),f=e.toString(),!isAlpha(f.charAt(0))){e.setStart(b.startContainer,c+1);break}if(b.endContainer.data)for(;d<b.endContainer.data.length;)if(e.setEnd(b.endContainer,++d),f=e.toString(),!isAlpha(f.charAt(f.length-1))){e.setEnd(b.endContainer,d-1);break}var g=e.toString();if(prevWord==g)return!0;prevWord=g,g.length>=1&&setTimeout(function(){var b=window.getSelection();b.removeAllRanges(),b.addRange(e);var c=pX,d=pY,f=a.screenX,h=a.screenY;getYoudaoDict(g,pX,pY,a.screenX,a.screenY,function(a){createPopUpEx(a,c,d,f,h)})},50)}},TriggerDelay))},!0),document.onmousedown=function(a){OnCheckCloseWindow()};var inDictPannel=!1;chrome.runtime.onMessage.addListener(function(a,b,c){a.optionChanged&&(Options=a.optionChanged)});